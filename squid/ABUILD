pkgname=squid
pkgver=3.1.10
pkgbuild=1
arch=("auto")
shortdesc=("HTTP/FTP proxy")
longdesc=("Squid is a high-performance proxy caching server for web clients, supporting FTP, gopher, and HTTP data objects.")
tags=("server net-misc")

source=("http://www.squid-cache.org/Versions/v3/3.1/squid-${pkgver}.tar.bz2")

build() {

cd $srcdir/$pkgname-$pkgver
burn_patches

CFLAGS="$SLKCFLAGS" \
CXXFLAGS="$SLKCFLAGS" \
./configure \
--prefix=/usr \
--libdir=/usr/lib${LIBDIRSUFFIX} \
--sysconfdir=/etc/squid \
--localstatedir=/var/lib/squid \
--datadir=/usr/share/squid \
--mandir=/usr/man \
--enable-carp \
--enable-icmp \
--enable-delay-pools \
--enable-useragent-log \
--enable-referer-log \
--enable-wccp \
--enable-wccpv2 \
--enable-kill-parent-hack \
--enable-snmp \
--enable-arp-acl \
--enable-ssl \
--enable-htcp \
--enable-ipf-trasparent \
--enable-linux-netfilter \
--enable-x-accelerator-vary \
--enable-follow-x-forwarded-for \
--enable-default-err-language=Russian-1251 \
--enable-err-language="Russian-1251 English" \
--enable-auth="basic digest negotiate ntlm" \
--enable-basic-auth-helpers="DB LDAP MSNT NCSA POP3 PAM SASL SMB YP getpwnam multi-domain-NTLM" \
--enable-ntlm-auth-helpers="fakeauth no_check" \
--enable-digest-auth-helpers="ldap password" \
--enable-negotiate-auth-helpers="squid_kerb_auth" \
--enable-external-acl-helpers="ip_user ldap_group session unix_group wbinfo_group" \
--with-large-files || exit 1

make -j${numjobs} all || exit 1
make install DESTDIR=${pkgdir} || exit 1

# OpenRC init
mkdir -p ${pkgdir}/etc/conf.d
mkdir -p ${pkgdir}/etc/init.d
cat ${filedir}/squid.init > ${pkgdir}/etc/init.d/squid
chmod 755 ${pkgdir}/etc/init.d/squid
cat ${filedir}/squid.conf > ${pkgdir}/etc/conf.d/squid.new

chown nobody:nobody ${pkgdir}/var/lib/squid/logs
chown nobody:nobody ${pkgdir}/var/lib/squid

mv ${pkgdir}/etc/squid/mime.conf ${pkgdir}/etc/squid/mime.conf.new
mv ${pkgdir}/etc/squid/squid.conf ${pkgdir}/etc/squid/squid.conf.new
mv ${pkgdir}/etc/squid/cachemgr.conf ${pkgdir}/etc/squid/cachemgr.conf.new
mv ${pkgdir}/etc/squid/msntauth.conf ${pkgdir}/etc/squid/msntauth.conf.new

}

