# ABUILD generated by mkpkg_generator.sh

pkgname=vim
pkgver=7.3
pkgbuild=5
arch=('auto')

shortdesc=('vim (Vi IMproved)')
longdesc=('Vim is an almost compatible version of the UNIX editor vi. Many new features have been added: multi level undo, command line history, filename completion, block operations, and more. Vim development is led by Bram Moolenaar. This package also contains the Exuberant Ctags program written by Darren Hiebert.')

tags=('app-editors console')

source=("ftp://ftp.vim.org/pub/vim/unix/vim-${pkgver}.tar.bz2")

build_deps='acl attr gpm glibc-solibs lftp'

PYVER=$(python -V 2>&1 | cut -f 2 -d' ' | cut -f 1-2 -d.)
CTAGSVER=5.8

# Error protection

config_vim() {
CFLAGS="$SLKCFLAGS" \
./configure \
  $* \
  --prefix=/usr \
  --enable-pythoninterp \
  --with-python-config-dir=/usr/lib${LIBDIRSUFFIX}/python$PYVER/config \
  --enable-perlinterp \
  --disable-tclinterp \
  --enable-multibyte \
  --enable-cscope \
  --with-features=huge \
  --with-compiledby="AgiliaLinux" \
  --build=$ARCH-slackware-linux

  # I had been adding this, but got 100% complaints and 0% kudos:
  #  --enable-rubyinterp
}





build() {
	mkdir -p $startdir/__vim_patches
	cd $startdir/__vim_patches
	echo mget ${pkgver}.'*' | lftp ftp://ftp.vim.org/pub/vim/patches/${pkgver}/
	go_src_dir
	for i in $startdir/__vim_patches/* ; do
		echo Patching $i
		patch -p0 < $i || exit 1 > /dev/null
		pkgver=`basename $i`
	done

	echo "VIM version: $pkgver"

	# Build CTAGS
	mkdir $startdir/ctags-$CTAGSVER
	cd $startdir/ctags-$CTAGSVER

	wget http://citylan.dl.sourceforge.net/project/ctags/ctags/$CTAGSVER/ctags-$CTAGSVER.tar.gz
	tar xf ctags-$CTAGSVER.tar.gz
	cd ctags-$CTAGSVER
	chown -R root:root .
	find . \
		\( -perm 777 -o -perm 775 -o -perm 711 -o -perm 555 -o -perm 511 \) \
		-exec chmod 755 {} \; -o \
		\( -perm 666 -o -perm 664 -o -perm 600 -o -perm 444 -o -perm 440 -o -perm 400 \) \
		-exec chmod 644 {} \;
	CFLAGS="$SLKCFLAGS" LDFLAGS="$SLKLDFLAGS" \
	./configure \
		--prefix=/usr \
		--build=$ARCH-slackware-linux
	make -j${numjobs} || make || exit 1
	mkdir -p $pkgdir/usr/bin
	cat ctags > $pkgdir/usr/bin/ctags
	chmod 755 $pkgdir/usr/bin/ctags
	mkdir -p $pkgdir/usr/man/man1
	cat ctags.1 | gzip -9c > $pkgdir/usr/man/man1/ctags.1.gz
	mkdir -p $pkgdir/usr/doc/ctags-$CTAGSVER
	cp -a \
		COPYING EXTENDING.html FAQ INSTALL INSTALL.oth NEWS README \
		$pkgdir/usr/doc/ctags-$CTAGSVER
	chmod 644 $pkgdir/usr/doc/ctags-$CTAGSVER/*

	go_src_dir
	
	# If there's no syntax update, create one:
	rm -rf runtime/syntax.orig
	cp -a runtime/syntax runtime/syntax.orig
	echo "Fetching vim syntax updates from ftp.nluug.nl..."
	rsync -avzcP ftp.nluug.nl::Vim/runtime/syntax/ runtime/syntax/
	diff -u -r --new-file runtime/syntax.orig runtime/syntax | gzip -9c > $startdir/vim-runtime-syntax.diff.gz
	rm -rf runtime/syntax
	mv runtime/syntax.orig runtime/syntax
	

	echo "Applying syntax updates"
	# Apply the syntax update:
	zcat $startdir/vim-runtime-syntax.diff.gz | patch -p0 --verbose

	burn_patches

	# Configure vim. For gvim, there will be little other options
	config_vim --without-x --disable-gui
	make -j${numjobs} || make || exit 1
	make install DESTDIR=$pkgdir || exit 1

	rsync -lprvt $pkgdir/usr/share/man/ $pkgdir/usr/man/
	rm -r $pkgdir/usr/share/man

	cp -a runtime/vimrc_example.vim runtime/vimrc.new

	# Don't make backups in /var/spool/cron/*, which fixes "crontab -e":
	zcat $filedir/vim.vimrc.diff.gz | patch -p1 --verbose || exit 1

	# Add patched vimrc to the package:
	cat runtime/vimrc.new > $pkgdir/usr/share/vim/vimrc.new

	# Fix manpage symlinks:
	if [ -d $pkgdir/usr/man ]; then
		( cd $pkgdir/usr/man
			for manpagedir in $(find . -type d -name "man*") ; do
				( cd $manpagedir
					for eachpage in $( find . -type l -maxdepth 1) ; do
						ln -s $( readlink $eachpage ).gz $eachpage.gz
						rm $eachpage
					done
					gzip -9 *.?
				)
			done
		)
	fi

	# Legacy binary links:
	( cd $pkgdir/usr/bin ; rm -rf ex )
	( cd $pkgdir/usr/bin ; ln -sf vim ex )
	( cd $pkgdir/usr/bin ; rm -rf rview )
	( cd $pkgdir/usr/bin ; ln -sf vim rview )
	( cd $pkgdir/usr/bin ; rm -rf rvim )
	( cd $pkgdir/usr/bin ; ln -sf vim rvim )
	( cd $pkgdir/usr/bin ; rm -rf view )
	( cd $pkgdir/usr/bin ; ln -sf vim view )
	( cd $pkgdir/usr/bin ; rm -rf eview )
	( cd $pkgdir/usr/bin ; ln -sf vim eview )
	( cd $pkgdir/usr/bin ; rm -rf evim )
	( cd $pkgdir/usr/bin ; ln -sf vim evim )
	

}

