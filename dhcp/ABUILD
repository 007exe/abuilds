# ABUILD generated by mkpkg_generator.sh

pkgname=dhcp
pkgver=4.2.1_P1
srcver=`echo $pkgver | sed -e s/_/-/g`
pkgbuild=1
arch=("auto")


shortdesc=("dhcp (DHCP server and client utilities)")
longdesc=("This package provides the ISC's DHCP utilities, including both a server and client. The DHCP protocol allows a host to contact a central server which maintains a list of IP addresses which may be assigned on one or more subnets. A DHCP client may request an address from this pool, and then use it temporarily for communication on the network. The DHCP protocol also provides a mechanism whereby a client can learn important details about the network to which it is attached, such as the location of a default router or name server.")

tags=("network net-dhcp")

source=("http://ftp.isc.org/isc/${pkgname}/${pkgname}-${srcver}.tar.gz")

adddep="glibc-solibs openssl"

BUILD_SYSTEM="autotools"
BUILD_KEYS="--prefix=/usr \
	--sysconfdir=/etc \
	--localstatedir=/var \
	--infodir=/usr/info \
	--mandir=/usr/man \
	--libdir=/usr/lib${LIBDIRSUFFIX} \
	--docdir=/usr/doc/dhcp-$pkgver \
	--with-srv-lease-file=/var/state/dhcp/dhcpd.leases \
	--with-srv6-lease-file=/var/state/dhcp/dhcpd6.leases \
	--with-cli-lease-file=/var/state/dhcp/dhclient.leases \
	--with-cli6-lease-file=/var/state/dhcp/dhclient6.leases"

INSTALL_KEYS="DESTDIR=$pkgdir"

config_files="etc/dhcpd.conf
etc/dhclient.conf
etc/conf.d/dhcpd
etc/conf.d/dhcrelay"

after_build() {
	go_src_dir
	set -e
	# DHCP libraries need not be included, yet.
	rm -rf ${pkgdir}/usr/{include,lib${LIBDIRSUFFIX}}

	# We need this in /sbin
	mkdir -p ${pkgdir}/sbin
	mv ${pkgdir}/usr/sbin/dhclient ${pkgdir}/sbin

	# Install the dhclient-script for linux
	cat client/scripts/linux > ${pkgdir}/sbin/dhclient-script
	chmod 700 ${pkgdir}/sbin/dhclient-script

	# Create the initial *.leases files:
	mkdir -p ${pkgdir}/var/state/dhcp
	touch ${pkgdir}/var/state/dhcp/dhcpd.leases.new
	touch ${pkgdir}/var/state/dhcp/dhcpd6.leases.new
	touch ${pkgdir}/var/state/dhcp/dhclient.leases.new
	touch ${pkgdir}/var/state/dhcp/dhclient6.leases.new

	# OpenRC scripts
	mkdir ${pkgdir}/etc/{init.d,conf.d}
	install -m0755 ${filedir}/dhcpd.init3 ${pkgdir}/etc/init.d/dhcpd
	install -m0755 ${filedir}/dhcrelay.init2 ${pkgdir}/etc/init.d/dhcrelay
	install -m0644 ${filedir}/dhcpd.conf ${pkgdir}/etc/conf.d/dhcpd
	install -m0644 ${filedir}/dhcrelay.conf ${pkgdir}/etc/conf.d/dhcrelay

	# Fix paths in init script
	if [ "$LIBDIRSUFFIX" != "" ] ; then
		sed -i -e "s/\/usr\/lib\//\/usr\/lib$LIBDIRSUFFIX\//g" ${pkgdir}/etc/init.d/dhcpd
	fi

	# Fix default configuration files.
	cat ${filedir}/etc/dhcpd.conf ${pkgdir}/etc/dhcpd.conf
	cat ${filedir}/etc/dhclient.conf ${pkgdir}/etc/dhclient.conf
	set +e
}

