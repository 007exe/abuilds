#ABUILD created by/создан: fat0troll, fat0troll at riseup.net 
pkgname=urbanterror
pkgver=4.1.1
pkgbuild=1
arch=('auto')

shortdesc="tactical shooter on q3 engine"
longdesc=("Urban Terror is a team-based tactical shooter based on the Quake 3 Engine (Stand-Alone Version)")

source=("ftp://ftp.snt.utwente.nl/pub/games/urbanterror/full_install/linux_or_mac/UrbanTerror${pkgver//./}.zip"
"http://ftp.snt.utwente.nl/pub/games/urbanterror/iourbanterror/source/complete/ioUrbanTerrorSource_2007_12_20.zip")

tags="games games-fps"

adddep="urbanterror-data"

pkglist="urbanterror_data"

urbanterror_data() {
	pkgname=urbanterror-data
	arch=('noarch')

	shortdesc="tactical shooter on q3 engine (data files)"
	longdesc=("Urban Terror is a team-based tactical shooter based on the Quake 3 Engine. This package contains data files")
	adddep="urbanterror"

}


build() {
	set -e
	cd $srcdir
	patch -Np0 -i ${filedir}/urbanterror_home.patch
	#compile client
	cd $srcdir/ioUrbanTerrorClientSource
	patch -Np0 -i ${filedir}/default-curl_lib.patch
	make -j1
	#compile server
	cd $srcdir/ioUrbanTerrorServerSource
	patch -Np1 -i $filedir/cmd.c.patch
	patch -Np1 -i $filedir/g_cmds.c.patch
	patch -Np1 -i $filedir/qcommon.h.patch
	patch -Np1 -i $filedir/sv_client.c.patch
	patch -Np1 -i $filedir/sv_main.c.patch
	make -j1
	set +e
}

after_build() {
	set -e
	## prepare folder
	install -d $pkgdir/opt/urbanterror/q3ut4/
	
	cd $pkgdir/opt/urbanterror
	
	# copy execs
	install -m755 $srcdir/ioUrbanTerrorClientSource/build/release-linux-*/ioUrbanTerror.* ioUrbanTerror
	install -m755 $srcdir/ioUrbanTerrorServerSource/build/release-linux-*/ioUrTded.* ioUrTded


	cd $pkgdir/opt/urbanterror

	## desktop launcher
	install -Dm644 $filedir/urbanterror.desktop $pkgdir/usr/share/applications/urbanterror.desktop
	install -Dm644 $filedir/urbanterror.png $pkgdir/usr/share/pixmaps/urbanterror.png

	## launch scripts
	install -Dm755 $filedir/urbanterror.sh $pkgdir/usr/bin/urbanterror
	install -Dm755 $filedir/urbanterror-server.sh $pkgdir/usr/bin/urbanterror-server
	set +e
}

urbanterror_data_prep() {
	set -e
	## copy base UT files to package urbanterror-data
	#install -m644 $srcdir/UrbanTerror/q3ut4/*.{cfg,pk3,txt} baseut4/ #needs more room on disk
	mkdir -p $pkgdir/opt/urbanterror/q3ut4
	cd $pkgdir/opt/urbanterror
	for i in $srcdir/UrbanTerror/q3ut4/*.{cfg,pk3,txt}; do
	    mv "$i" q3ut4/
	    chmod 644 "q3ut4/$(basename "$i")"
	done
	set +e

}
